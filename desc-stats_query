-- Join tables & use CTE to return descriptive statistics.

WITH descriptive_stats_cte (
  film_id, genre, rating, rental_rate, 
  rental_duration, language, customer_id, 
  country_id, amount
) AS (
  SELECT 
    F.film_id, 
    E.name, 
    F.rating, 
    F.rental_rate, 
    F.rental_duration, 
    G.name, 
    A.customer_id, 
    J.country_id, 
    K.amount 
  FROM 
    customer A 
    INNER JOIN rental B ON A.customer_id = B.customer_id 
    INNER JOIN inventory C ON B.inventory_id = C.inventory_id 
    INNER JOIN film_category D ON C.film_id = D.film_id 
    INNER JOIN category E ON D.category_id = E.category_id 
    INNER JOIN film F ON C.film_id = F.film_id 
    INNER JOIN language G ON F.language_id = G.language_id 
    INNER JOIN address H ON A.address_id = H.address_id 
    INNER JOIN city I ON H.city_id = I.city_id 
    INNER JOIN country J ON I.country_id = J.country_id 
    INNER JOIN payment K ON B.rental_id = K.rental_id
) 
SELECT 
  COUNT(DISTINCT film_id) AS film_count, 
  MODE() WITHIN GROUP (
    ORDER BY 
      genre
  ) AS modal_genre, 
  MODE() WITHIN GROUP (
    ORDER BY 
      rating
  ) AS modal_rating, 
  ROUND(
    AVG(rental_rate), 
    2
  ) AS avg_rental_cost, 
  ROUND(
    AVG(rental_duration)
  ) AS avg_rental_duration, 
  MODE() WITHIN GROUP (
    ORDER BY 
      language
  ) AS modal_language, 
  COUNT (DISTINCT customer_id) AS customer_count, 
  COUNT(DISTINCT country_id) AS country_count, 
  ROUND(
    SUM(amount)
  ) AS total_revenue 
FROM 
  descriptive_stats_cte;
